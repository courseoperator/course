<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Course Syllabus Lookup</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Arial, "Noto Sans TC", sans-serif; margin: 0; }
    header { padding: 16px 18px; border-bottom: 1px solid #e5e5e5; }
    main { padding: 16px 18px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    input { padding: 10px 12px; font-size: 16px; width: 220px; }
    button, select { padding: 10px 14px; font-size: 16px; cursor: pointer; }
    .hint { color: #666; font-size: 14px; margin-top: 8px; }
    .status { margin: 12px 0; font-size: 14px; white-space: pre-wrap; }
    .status.error { color: #b00020; }
    .status.ok { color: #0b6b0b; }
    .viewer-wrap { margin-top: 14px; border-top: 1px solid #eee; padding-top: 14px; }
    iframe { width: 100%; height: 60vh; border: 1px solid #ddd; border-radius: 6px; }
    .meta { margin: 6px 0 0; color: #333; font-size: 14px; }
    code { background: #f5f5f5; padding: 2px 6px; border-radius: 4px; }

    .translate-wrap { margin-top: 14px; border-top: 1px solid #eee; padding-top: 14px; }
    .panel { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .box { border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #fff; min-height: 220px; }
    textarea { width: 100%; min-height: 220px; border: none; outline: none; resize: vertical; font-size: 14px; line-height: 1.5; }
    .small { font-size: 13px; color: #666; }
    .tools { display:flex; gap:10px; flex-wrap: wrap; align-items:center; margin: 10px 0; }
  </style>

  <!-- PDF.js (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.js"></script>
</head>

<body>
  <header>
    <h2 style="margin:0;">課程碼查詢課綱（PDF）+ 翻譯</h2>
    <div class="hint">
      輸入四位數課程碼，例如 <code>0576</code>，即可顯示對應課綱 PDF。<br/>
      翻譯功能會先從 PDF 擷取文字（表格/排版複雜者可能會有順序差異）。
    </div>
  </header>

  <main>
    <div class="row">
      <input id="courseCode" inputmode="numeric" placeholder="輸入課程碼（四位數）" maxlength="4" />
      <button id="btnSearch">查詢</button>
      <button id="btnClear" type="button">清除</button>
    </div>

    <div id="status" class="status"></div>

    <div id="viewer" class="viewer-wrap" style="display:none;">
      <div id="meta" class="meta"></div>
      <iframe id="pdfFrame" title="Syllabus PDF Viewer"></iframe>
    </div>

    <div id="translateArea" class="translate-wrap" style="display:none;">
      <h3 style="margin:0 0 8px;">翻譯（擷取 PDF 文字後翻譯）</h3>

      <div class="tools">
        <label class="small">目標語言：</label>
        <select id="lang">
          <option value="en">English</option>
          <option value="ja">日本語</option>
          <option value="ko">한국어</option>
          <option value="vi">Tiếng Việt</option>
          <option value="th">ไทย</option>
          <option value="id">Bahasa Indonesia</option>
          <option value="es">Español</option>
          <option value="fr">Français</option>
          <option value="de">Deutsch</option>
        </select>

        <button id="btnExtract" type="button">① 擷取 PDF 文字</button>
        <button id="btnTranslate" type="button">② 翻譯成選定語言</button>
        <button id="btnCopy" type="button">複製翻譯結果</button>
      </div>

      <div class="panel">
        <div class="box">
          <div class="small">擷取出的原文（可手動修正後再翻譯）</div>
          <textarea id="sourceText" placeholder="請先按「擷取 PDF 文字」"></textarea>
        </div>
        <div class="box">
          <div class="small">翻譯結果</div>
          <textarea id="translatedText" placeholder="按「翻譯」後顯示"></textarea>
        </div>
      </div>

      <div class="small" style="margin-top:8px;">
        ⚠️ 注意：若課綱含大量表格、頁首頁尾、或掃描圖片，擷取文字可能不完整。此時建議改用「把課綱先轉成文字版（JSON/Word）」再翻譯，品質會最好。
      </div>
    </div>
  </main>

  <script>
    // ====== 基本設定 ======
    // 你的 Google Apps Script Web App URL（翻譯代理）
    const TRANSLATE_ENDPOINT = "https://script.google.com/macros/s/AKfycbzmMkx32IfB9rT9x3XIubiGv4RbRyWdzj9m2hdwFftQuQ7VrQupVrA9OUSeXlF-PB8qyA/exec";

    // 讀取索引表（課程碼 -> PDF路徑）
    let indexData = null;
    let currentPdfPath = null;

    async function loadIndex() {
      if (indexData) return indexData;
      const res = await fetch('./index.json', { cache: 'no-store' });
      if (!res.ok) throw new Error('無法載入 index.json（請確認檔案存在於 repo 根目錄）');
      indexData = await res.json();
      return indexData;
    }

    function setStatus(msg, type = '') {
      const el = document.getElementById('status');
      el.textContent = msg || '';
      el.className = 'status ' + (type || '');
    }

    function showViewer(show) {
      document.getElementById('viewer').style.display = show ? 'block' : 'none';
      document.getElementById('translateArea').style.display = show ? 'block' : 'none';
    }

    function sanitizeCode(raw) {
      return (raw || '').replace(/\D/g, '').slice(0, 4);
    }

    async function lookup() {
      try {
        const inputEl = document.getElementById('courseCode');
        const code = sanitizeCode(inputEl.value);
        inputEl.value = code;

        if (code.length !== 4) {
          setStatus('請輸入四位數課程碼。', 'error');
          showViewer(false);
          return;
        }

        setStatus('查詢中…');
        const idx = await loadIndex();

        const entry = idx[code];
        if (!entry || !entry.file) {
          setStatus(`查無課程碼 ${code} 的課綱檔案。請確認 index.json 是否已加入此課程碼。`, 'error');
          showViewer(false);
          return;
        }

        currentPdfPath = entry.file;

        const title = entry.title_zh ? `｜${entry.title_zh}` : '';
        document.getElementById('meta').textContent = `課程碼：${code} ${title}（檔案：${currentPdfPath}）`;

        document.getElementById('pdfFrame').src = currentPdfPath;

        // 清空翻譯區
        document.getElementById('sourceText').value = '';
        document.getElementById('translatedText').value = '';

        setStatus('已載入 PDF。接著可按「擷取 PDF 文字」。', 'ok');
        showViewer(true);

      } catch (err) {
        console.error(err);
        setStatus(`發生錯誤：${err.message}`, 'error');
        showViewer(false);
      }
    }

    function clearAll() {
      document.getElementById('courseCode').value = '';
      document.getElementById('pdfFrame').src = '';
      document.getElementById('meta').textContent = '';
      document.getElementById('sourceText').value = '';
      document.getElementById('translatedText').value = '';
      currentPdfPath = null;
      setStatus('');
      showViewer(false);
    }

    // ====== PDF 擷取文字（PDF.js） ======
    async function extractTextFromPdf(pdfUrl) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.worker.min.js";

      const loadingTask = pdfjsLib.getDocument({ url: pdfUrl });
      const pdf = await loadingTask.promise;

      let fullText = "";
      for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
        setStatus(`擷取中…（第 ${pageNum}/${pdf.numPages} 頁）`);
        const page = await pdf.getPage(pageNum);
        const content = await page.getTextContent();

        const pageText = content.items.map(it => it.str).join(" ");
        fullText += `\n\n[Page ${pageNum}]\n` + pageText;
      }
      return fullText.trim();
    }

    async function handleExtract() {
      if (!currentPdfPath) {
        setStatus('請先查詢並載入 PDF。', 'error');
        return;
      }
      try {
        setStatus('開始擷取 PDF 文字…');
        const text = await extractTextFromPdf(currentPdfPath);
        document.getElementById('sourceText').value = text || '';
        setStatus('擷取完成。你可以先手動微調內容，再按「翻譯」。', 'ok');
      } catch (e) {
        console.error(e);
        setStatus(`擷取失敗：${e.message}`, 'error');
      }
    }

    // ====== 翻譯：分段送到 Apps Script ======
    function chunkText(text, maxChars = 2000) {
      const chunks = [];
      let i = 0;
      while (i < text.length) {
        chunks.push(text.slice(i, i + maxChars));
        i += maxChars;
      }
      return chunks;
    }

    async function translateChunk(source, targetLang) {
      // Apps Script 對 CORS/headers 比較敏感，這種寫法最穩
      const res = await fetch(TRANSLATE_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({
          target_lang: targetLang,
          text: source
        })
      });

      if (!res.ok) {
        const t = await res.text();
        throw new Error(`翻譯失敗（HTTP ${res.status}）：${t.slice(0, 200)}`);
      }

      const data = await res.json(); // { translated_text: "..." } 或 { error: "..." }
      if (data.error) throw new Error(data.error);
      return data;
    }

    async function handleTranslate() {
      const src = document.getElementById('sourceText').value.trim();
      if (!src) {
        setStatus('沒有可翻譯內容。請先擷取 PDF 文字或貼上內容。', 'error');
        return;
      }

      const lang = document.getElementById('lang').value;

      try {
        setStatus('翻譯中…（分段處理）');
        const parts = chunkText(src, 2000);
        let out = "";

        for (let i = 0; i < parts.length; i++) {
          setStatus(`翻譯中…（段落 ${i + 1}/${parts.length}）`);
          const r = await translateChunk(parts[i], lang);
          out += (r.translated_text || "") + "\n";
        }

        document.getElementById('translatedText').value = out.trim();
        setStatus('翻譯完成。', 'ok');
      } catch (e) {
        console.error(e);
        setStatus(`翻譯失敗：${e.message}`, 'error');
      }
    }

    async function handleCopy() {
      const text = document.getElementById('translatedText').value;
      if (!text) {
        setStatus('目前沒有翻譯結果可複製。', 'error');
        return;
      }
      await navigator.clipboard.writeText(text);
      setStatus('已複製翻譯結果。', 'ok');
    }

    document.getElementById('btnSearch').addEventListener('click', lookup);
    document.getElementById('btnClear').addEventListener('click', clearAll);
    document.getElementById('btnExtract').addEventListener('click', handleExtract);
    document.getElementById('btnTranslate').addEventListener('click', handleTranslate);
    document.getElementById('btnCopy').addEventListener('click', handleCopy);

    document.getElementById('courseCode').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') lookup();
    });
  </script>
</body>
</html>
