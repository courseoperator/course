<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Course Syllabus Lookup</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Arial, "Noto Sans TC", sans-serif; margin: 0; }
    header { padding: 16px 18px; border-bottom: 1px solid #e5e5e5; }
    main { padding: 16px 18px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    input { padding: 10px 12px; font-size: 16px; width: 220px; }
    button, select { padding: 10px 14px; font-size: 16px; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .hint { color: #666; font-size: 14px; margin-top: 8px; }
    .status { margin: 12px 0; font-size: 14px; white-space: pre-wrap; }
    .status.error { color: #b00020; }
    .status.ok { color: #0b6b0b; }
    .viewer-wrap { margin-top: 14px; border-top: 1px solid #eee; padding-top: 14px; }
    iframe { width: 100%; height: 58vh; border: 1px solid #ddd; border-radius: 6px; }

    .meta { margin: 6px 0 0; color: #333; font-size: 14px; }
    code { background: #f5f5f5; padding: 2px 6px; border-radius: 4px; }

    .translate-wrap { margin-top: 14px; border-top: 1px solid #eee; padding-top: 14px; }
    .panel { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .box { border: 1px solid #ddd; border-radius: 10px; padding: 10px; background: #fff; min-height: 220px; }
    textarea { width: 100%; min-height: 220px; border: none; outline: none; resize: vertical; font-size: 14px; line-height: 1.5; }
    .small { font-size: 13px; color: #666; }
    .tools { display:flex; gap:10px; flex-wrap: wrap; align-items:center; margin: 10px 0; }
  </style>
</head>

<body>
  <header>
    <h2 style="margin:0;">課程碼查詢課綱（PDF）+ 翻譯</h2>
    <div class="hint">
      輸入四位數課程碼，例如 <code>0576</code>，即可顯示對應課綱 PDF。<br/>
      你可以在 PDF 畫面反白文字後按「複製」，再按「貼上」到原文框，最後按「翻譯」。
    </div>
  </header>

  <main>
    <div class="row">
      <input id="courseCode" inputmode="numeric" placeholder="輸入課程碼（四位數）" maxlength="4" />
      <button id="btnSearch">查詢</button>
      <button id="btnClear" type="button">清除</button>
    </div>

    <div id="status" class="status"></div>

    <div id="viewer" class="viewer-wrap" style="display:none;">
      <div id="meta" class="meta"></div>
      <iframe id="pdfFrame" title="Syllabus PDF Viewer"></iframe>
    </div>

    <div id="translateArea" class="translate-wrap" style="display:none;">
      <h3 style="margin:0 0 8px;">翻譯（手動複製 PDF 文字 → 貼上 → 翻譯）</h3>

      <div class="tools">
        <label class="small">目標語言：</label>
        <select id="lang">
          <option value="en">English</option>
          <option value="ja">日本語</option>
          <option value="ko">한국어</option>
          <option value="vi">Tiếng Việt</option>
          <option value="th">ไทย</option>
          <option value="id">Bahasa Indonesia</option>
          <option value="es">Español</option>
          <option value="fr">Français</option>
          <option value="de">Deutsch</option>
        </select>

        <!-- ✅ 你要的三顆按鈕 -->
        <button id="btnCopyFromPdf" type="button">複製</button>
        <button id="btnPasteToSource" type="button">貼上</button>
        <button id="btnTranslate" type="button">翻譯</button>

        <button id="btnCopyTranslated" type="button">複製翻譯結果</button>
      </div>

      <div class="panel">
        <div class="box">
          <div class="small">擷取出的原文（可手動修正後再翻譯）</div>
          <textarea id="sourceText" placeholder="在 PDF 反白文字後按「複製」，再按「貼上」到這裡"></textarea>
        </div>
        <div class="box">
          <div class="small">翻譯結果</div>
          <textarea id="translatedText" placeholder="按「翻譯」後顯示"></textarea>
        </div>
      </div>

      <div class="small" style="margin-top:8px;">
        提醒：PDF 內反白複製通常受瀏覽器/檔案內容影響；若「複製」被瀏覽器阻擋，請先在 PDF 內按 Ctrl+C，再用「貼上」即可。
      </div>
    </div>
  </main>

  <script>
    // ====== 設定：你的 Google Apps Script 翻譯端點 ======
    const TRANSLATE_ENDPOINT = "https://script.google.com/macros/s/AKfycbzmMkx32IfB9rT9x3XIubiGv4RbRyWdzj9m2hdwFftQuQ7VrQupVrA9OUSeXlF-PB8qyA/exec";

    // ====== 索引載入 ======
    let indexData = null;

    async function loadIndex() {
      if (indexData) return indexData;
      const res = await fetch('./index.json', { cache: 'no-store' });
      if (!res.ok) throw new Error('無法載入 index.json（請確認檔案存在於 repo 根目錄）');
      indexData = await res.json();
      return indexData;
    }

    function setStatus(msg, type = '') {
      const el = document.getElementById('status');
      el.textContent = msg || '';
      el.className = 'status ' + (type || '');
    }

    function showSections(show) {
      document.getElementById('viewer').style.display = show ? 'block' : 'none';
      document.getElementById('translateArea').style.display = show ? 'block' : 'none';
    }

    function sanitizeCode(raw) {
      return (raw || '').replace(/\D/g, '').slice(0, 4);
    }

    async function lookup() {
      try {
        const inputEl = document.getElementById('courseCode');
        const code = sanitizeCode(inputEl.value);
        inputEl.value = code;

        if (code.length !== 4) {
          setStatus('請輸入四位數課程碼。', 'error');
          showSections(false);
          return;
        }

        setStatus('查詢中…');
        const idx = await loadIndex();

        const entry = idx[code];
        if (!entry || !entry.file) {
          setStatus(`查無課程碼 ${code} 的課綱檔案。請確認 index.json 是否已加入此課程碼。`, 'error');
          showSections(false);
          return;
        }

        const rawPath = entry.file;           // 可能含空格
        const encodedPath = encodeURI(rawPath); // ✅ 避免空格造成問題

        const title = entry.title_zh ? `｜${entry.title_zh}` : '';
        document.getElementById('meta').textContent = `課程碼：${code} ${title}（檔案：${rawPath}）`;
        document.getElementById('pdfFrame').src = encodedPath;

        // 清空翻譯區
        document.getElementById('sourceText').value = '';
        document.getElementById('translatedText').value = '';

        setStatus('已載入 PDF。請在 PDF 反白文字後按「複製」。', 'ok');
        showSections(true);

      } catch (err) {
        console.error(err);
        setStatus(`發生錯誤：${err.message}`, 'error');
        showSections(false);
      }
    }

    function clearAll() {
      document.getElementById('courseCode').value = '';
      document.getElementById('pdfFrame').src = '';
      document.getElementById('meta').textContent = '';
      document.getElementById('sourceText').value = '';
      document.getElementById('translatedText').value = '';
      setStatus('');
      showSections(false);
    }

    // ====== 你要的三顆按鈕功能 ======

    // 1) 複製：嘗試從「目前使用者反白的文字」複製到剪貼簿
    async function copySelectionToClipboard() {
      try {
        // 注意：若反白在 iframe(PDF) 內，某些瀏覽器安全限制可能讓這裡讀不到 selection
        // 因此我們提供兩條路：
        // (A) 先嘗試用 window.getSelection()
        // (B) 若取不到，提示使用者在 PDF 內按 Ctrl+C
        const selected = window.getSelection ? String(window.getSelection()) : "";

        if (selected && selected.trim()) {
          await navigator.clipboard.writeText(selected);
          setStatus(`已複製選取文字（${selected.trim().length} 字）。接著按「貼上」。`, 'ok');
          return;
        }

        setStatus('未偵測到可複製的反白文字。若你是在 PDF 內反白，請直接按 Ctrl+C，再按「貼上」。', 'error');
      } catch (e) {
        console.error(e);
        setStatus('複製失敗：瀏覽器可能阻擋剪貼簿存取。請在 PDF 內用 Ctrl+C，然後按「貼上」。', 'error');
      }
    }

    // 2) 貼上：從剪貼簿讀取文字，貼到「擷取原文」框
    async function pasteFromClipboardToSource() {
      const ta = document.getElementById('sourceText');
      try {
        const text = await navigator.clipboard.readText();
        if (!text) {
          setStatus('剪貼簿沒有文字可貼上。', 'error');
          return;
        }
        // 追加貼上（你也可改成覆蓋：ta.value = text;）
        ta.value = ta.value ? (ta.value + "\n" + text) : text;
        ta.focus();
        setStatus(`已貼上（${text.length} 字）。可再按「翻譯」。`, 'ok');
      } catch (e) {
        console.error(e);
        setStatus('貼上失敗：瀏覽器可能不允許讀取剪貼簿。你可以直接在原文框按 Ctrl+V。', 'error');
      }
    }

    // 3) 翻譯：把原文框內容送到 Apps Script 翻譯，顯示在翻譯框
    function chunkText(text, maxChars = 2000) {
      const chunks = [];
      let i = 0;
      while (i < text.length) {
        chunks.push(text.slice(i, i + maxChars));
        i += maxChars;
      }
      return chunks;
    }

    async function translateChunk(source, targetLang) {
      const res = await fetch(TRANSLATE_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ target_lang: targetLang, text: source })
      });

      if (!res.ok) {
        const t = await res.text();
        throw new Error(`翻譯失敗（HTTP ${res.status}）：${t.slice(0, 200)}`);
      }

      const data = await res.json();
      if (data.error) throw new Error(data.error);
      return data.translated_text || "";
    }

    async function translateAll() {
      const src = document.getElementById('sourceText').value.trim();
      if (!src) {
        setStatus('原文框沒有內容。請先「貼上」或手動輸入文字。', 'error');
        return;
      }

      const lang = document.getElementById('lang').value;
      const btn = document.getElementById('btnTranslate');
      btn.disabled = true;

      try {
        const parts = chunkText(src, 2000);
        let out = "";

        for (let i = 0; i < parts.length; i++) {
          setStatus(`翻譯中…（段落 ${i + 1}/${parts.length}）`);
          out += await translateChunk(parts[i], lang) + "\n";
        }

        document.getElementById('translatedText').value = out.trim();
        setStatus('翻譯完成。', 'ok');
      } catch (e) {
        console.error(e);
        setStatus(`翻譯失敗：${e.message}`, 'error');
      } finally {
        btn.disabled = false;
      }
    }

    async function copyTranslated() {
      const text = document.getElementById('translatedText').value;
      if (!text) {
        setStatus('目前沒有翻譯結果可複製。', 'error');
        return;
      }
      try {
        await navigator.clipboard.writeText(text);
        setStatus('已複製翻譯結果。', 'ok');
      } catch (e) {
        console.error(e);
        setStatus('複製翻譯結果失敗：瀏覽器可能阻擋剪貼簿存取。', 'error');
      }
    }

    // ====== 綁定事件 ======
    document.getElementById('btnSearch').addEventListener('click', lookup);
    document.getElementById('btnClear').addEventListener('click', clearAll);

    document.getElementById('btnCopyFromPdf').addEventListener('click', copySelectionToClipboard);
    document.getElementById('btnPasteToSource').addEventListener('click', pasteFromClipboardToSource);
    document.getElementById('btnTranslate').addEventListener('click', translateAll);
    document.getElementById('btnCopyTranslated').addEventListener('click', copyTranslated);

    document.getElementById('courseCode').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') lookup();
    });
  </script>
</body>
</html>
